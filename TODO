* Refactor patch to support conditional ZTS
