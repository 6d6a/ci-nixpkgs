pkgs = ([
        // Deprecated
        'openssl', 'postfixDeprecated',
        'php56', 'php55', 'php54', 'php53', 'php52',

        'zendguard', 'zendguard53', 'zendguard54', 'zendguard55', 'zendguard56',

        'php52-dbase', 'php52-imagick', 'php52-intl', 'php52-timezonedb',
        'php52-zendopcache',

        'php53-dbase', 'php53-imagick', 'php53-intl', 'php53-timezonedb',
        'php53-zendopcache',

        'php54-imagick', 'php54-memcached', 'php54-redis', 'php54-timezonedb',
        'php54-zendopcache',

        'php55-dbase', 'php55-imagick', 'php55-intl', 'php55-timezonedb',

        'php56-dbase', 'php56-imagick', 'php56-intl', 'php56-timezonedb',
        'apacheHttpd', 'apacheHttpdmpmITK',

        // Utilities

        'connectorc', 'libjpeg130', 'libpng12', 'elktail', 'clamchk',

        // Postfix

        'sendmail',

        // PHP

        'php70', 'php71', 'php72', 'php73', 'php74',

        'php70-imagick', 'php70-memcached', 'php70-redis', 'php70-rrd',
        'php70-timezonedb',

        'php71-imagick', 'php71-libsodiumPhp', 'php71-memcached', 'php71-redis',
        'php71-rrd', 'php71-timezonedb',

        'php72-imagick', 'php72-memcached', 'php72-redis', 'php72-rrd',
        'php72-timezonedb',

        'php73-imagick', 'php73-memcached', 'php73-redis', 'php73-rrd',
        'php73-timezonedb', 'pure-ftpd',

        'php73Private-imagick', 'php73Private-memcached', 'php73Private-redis',
        'php73Private-rrd', 'php73Private-timezonedb',

        // Misc

        'inetutilsMinimal', 'deepdiff', 'nss-certs.unbundled', 'locale',

        'nginxModules', 'nginx', 'openrestyLuajit2', 'perl', 'pcre831',
        'postfix', 'penlight', 'sockexec', 'zendoptimizer', 'libjpegv6b',
        'imagemagick68', 'libxml_perl', 'libnet', 'libintl_perl',
        'commonsense']

        // Perl
        + ['TextTruncate', 'TimeLocal', 'PerlMagick', 'Mojolicious', 'LWP',
           'ListMoreUtilsXS', 'LWPProtocolHttps', 'DBI', 'DBDmysql', 'CGI',
           'FilePath', 'DigestPerlMD5', 'DigestSHA1', 'FileBOM', 'GD',
           'LocaleGettext', 'HashDiff', 'JSONXS', 'POSIXstrftimeCompiler',
           'URIEscape', 'HTMLParser', 'HTTPDate', 'TryTiny',
           'TypesSerialiser', 'XMLLibXML', 'XMLSAX', 'XMLSAXBase', 'Carp',
           'NetHTTP', 'DateTime', 'AlgorithmDiff', 'AuthenSASL', 'CacheMemcached',

           // failed to find: 'WPUserAgentDetermined' , 'Webinject', 'UnicodeUTF8', , 'UnicodeMap', 'TextASCIITable' 2'TermSize',  'ScalarUtilNumeric' , 'RPCXML' , 'Quota', 'NetIPv6Addr', , 'NetIPv4Addr' 'NetCUPS', 'AlgorithmDiffXS' 'ApacheReload' 'DateCalcXS', , 'YAMLSyck' 'DigestBubbleBabble'  'Dpkg', 'Filechmod', 'FileFcntlLock', 'HTMLFormat', 'HTMLTemplatePro', 'IOSocketINET6', , 'libwwwperl', 'libxmlperl', 'YAMLAppConfig' , 'MIMEBase32' 'mimetypes',  'NagiosPlugin',

           // failing test: 'NetAddrIP', 'DataValidateIP'

           'AlgorithmDiff', 'AlgorithmMerge', 'ArchiveExtract',
           'AuthenSASL', 'BitVector', 'BSDResource', 'CacheMemcached',
           'CarpAssert', 'CarpClan', 'ClassAccessor',
           'ClassFactoryUtil', 'ClassLoad', 'ClassLoadXS',
           'ClassSingleton', 'commonsense', 'ConfigIniFiles',
           'ConfigTiny', 'CryptSSLeay', 'DataOptList', 'DateCalc',
           'DateManip', 'DateTimeFormatBuilder',
           'DateTimeFormatISO8601', 'DBDmysql', 'DevelSymdump',
           'DigestHMAC', 'EmailDateFormat', 'EncodeLocale',
           'FileCopyRecursive', 'FileListing', 'FilePid', 'FontAFM',
           'GD', 'HTMLForm', 'HTMLParser', 'HTMLTagset',
           'HTMLTemplate', 'HTMLTree', 'HTTPCookies', 'HTTPDaemon',
           'HTTPDate', 'HTTPMessage', 'HTTPNegotiate', 'IOHTML',
           'IOSocketSSL', 'IOString', 'IOstringy', 'IPCRun', 'JSON',
           'JSONXS', 'ListAllUtils', 'ListMoreUtils',
           'LogMessageSimple', 'LWPMediaTypes', 'LWPProtocolhttps',
           'MailIMAPClient', 'MailTools', 'MathCalcUnits', 'MIMELite',
           'ModuleImplementation', 'ModulePluggable', 'ModuleRuntime',
           'NetHTTP', 'NetIP', 'NetNetmask', 'NetSMTPSSL',
           'NetSMTPTLS', 'NetSSLeay', 'OLEStorage_Lite',
           'PackageStash', 'PackageStashXS', 'ParallelForkManager',
           'ParamsClassify', 'ParamsUtil', 'ParamsValidate',
           'ParseRecDescent', 'PodLaTeX', 'Readonly', 'ReadonlyXS',
           'Socket6', 'SpreadsheetParseExcel',
           'SpreadsheetWriteExcel', 'StringCRC32', 'SubInstall',
           'SubName', 'Switch', 'TemplateToolkit', 'TermReadKey',
           'TermUI', 'TextCharWidth', 'TextIconv', 'TextSoundex',
           'TextWrapI18N', 'TimeDate', 'TryTiny', 'UnicodeString',
           'URI', 'WWWRobotRules', 'XMLLibXML', 'XMLNamespaceSupport',
           'XMLSAX', 'XMLSAXBase', 'XMLSAXExpat', 'XMLSimple',
           'YAML'].collect{"mjPerlPackages.$it"})

pipeline {
    agent {
        label 'nixbld'
    }
    stages {
        stage('Build overlay') {
            steps {
                script {
                    sh ([". /home/jenkins/.nix-profile/etc/profile.d/nix.sh",

                         // Show derivations
                         pkgs.collect{
                                ["nix-instantiate", "build.nix",
                                 "--show-trace", "--cores", "16",
                                 "-A overlay.$it", "2>/dev/null"].join(" ")
                            }.join(" && "),

                         // Build specified packages in overlay
                         [["nix-build", "build.nix",
                           "--cores", "16",
                           "--keep-failed", "--show-trace"].join(" "),
                          pkgs.collect{"-A overlay.$it"}.join(" ")].join(" ")

                        ].join(" && "))
                }
            }
        }
    }
    post {
        success { notifySlack "Build ${JOB_NAME} succeeded" , "green" }
        failure { notifySlack "Build failled: ${JOB_NAME} [<${RUN_DISPLAY_URL}|${BUILD_NUMBER}>]", "red" }
    }
}
